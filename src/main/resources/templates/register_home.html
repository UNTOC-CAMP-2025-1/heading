<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì›ê°€ì…</title>
    <script>
        let verifiedToken = "";
        let verificationStartTime = null;

        async function checkUsername() {
            const username = document.getElementById("username").value;
            const result = await fetch(`/check-username?username=${username}`);
            const available = await result.json();
            const message = document.getElementById("usernameMessage");
            if (available) {
                message.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                message.style.color = "green";
            } else {
                message.innerText = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                message.style.color = "red";
            }
        }

        async function checkBojId() {
            const bojId = document.getElementById("bojId").value;
            const result = await fetch(`/check-boj-id?bojId=${bojId}`);
            const available = await result.json();
            const message = document.getElementById("bojIdMessage");
            const verifyBtn = document.getElementById("verifyBtn");

            if (available) {
                message.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ë°±ì¤€ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                message.style.color = "green";
                verifyBtn.disabled = false;
            } else {
                message.innerText = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ê±°ë‚˜ ì˜ëª»ëœ ë°±ì¤€ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                message.style.color = "red";
                verifyBtn.disabled = true;
            }
        }

        async function requestToken() {
            const bojId = document.getElementById("bojId").value;
            const result = await fetch(`/boj/token`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ bojId: bojId })
            });
            if (result.ok) {
                verifiedToken = await result.text();
                verificationStartTime = new Date();
                document.getElementById("verifyMessage").innerText = `ìê¸°ì†Œê°œë€ì— ë‹¤ìŒ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ${verifiedToken}`;
                document.getElementById("bioVerifyBtn").disabled = false;
            } else {
                alert("í† í° ìƒì„± ì‹¤íŒ¨");
            }
        }

        async function verifyBio() {
            const bojId = document.getElementById("bojId").value;
            const now = new Date();
            const elapsedSeconds = (now - verificationStartTime) / 1000;
            if (elapsedSeconds > 180) {
                alert("3ë¶„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦ì„ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }

            const result = await fetch("/boj/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ bojId: bojId, token: verifiedToken })
            });

            const message = await result.text();
            if (result.ok) {
                document.getElementById("submitBtn").disabled = false;
                alert("âœ… ì¸ì¦ ì„±ê³µ! íšŒì›ê°€ì… ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.\n\n" + message);
            } else {
                alert("âŒ ì¸ì¦ ì‹¤íŒ¨: " + message);
            }
        }

        function validatePassword() {
            const pw1 = document.getElementById("password").value;
            const pw2 = document.getElementById("confirmPassword").value;
            const msg = document.getElementById("pwMessage");
            if (pw1.length >= 6 && pw1 === pw2) {
                msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ìœ íš¨í•©ë‹ˆë‹¤.";
                msg.style.color = "green";
            } else {
                msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ 6ì ë¯¸ë§Œì…ë‹ˆë‹¤.";
                msg.style.color = "red";
            }
        }

        async function submitForm(event) {
            event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const bojId = document.getElementById("bojId").value;

            const response = await fetch("/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    bojId: bojId
                })
            });

            const message = await response.text();
            if (response.ok) {
                alert("ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ: " + message);
                window.location.href = "/login-home"; // ì„±ê³µ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            } else {
                alert("âŒ íšŒì›ê°€ì… ì‹¤íŒ¨: " + message);
            }
        }
    </script>
</head>
<body>
<h2>íšŒì›ê°€ì…</h2>
<form onsubmit="submitForm(event)">
    <label>ì•„ì´ë””: <input type="text" id="username" name="username"></label>
    <button type="button" onclick="checkUsername()">ì¤‘ë³µ ì²´í¬</button>
    <span id="usernameMessage"></span>
    <br><br>

    <label>ë¹„ë°€ë²ˆí˜¸: <input type="password" id="password" name="password" oninput="validatePassword()"></label><br>
    <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸: <input type="password" id="confirmPassword" oninput="validatePassword()"></label>
    <span id="pwMessage"></span>
    <br><br>

    <label>ë°±ì¤€ ì•„ì´ë””: <input type="text" id="bojId" name="bojId"></label>
    <button type="button" onclick="checkBojId()">ì¤‘ë³µ ì²´í¬</button>
    <span id="bojIdMessage"></span><br>

    <button type="button" id="verifyBtn" onclick="requestToken()" disabled>ì¸ì¦í•˜ê¸°</button><br>
    <p id="verifyMessage"></p>
    <button type="button" id="bioVerifyBtn" onclick="verifyBio()" disabled>ìê¸°ì†Œê°œ í™•ì¸</button>
    <br><br>

    <button type="submit" id="submitBtn" disabled>íšŒì›ê°€ì…</button>
</form>
</body>
</html>
